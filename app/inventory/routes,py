from flask import request, jsonify
from extensions import db
from models import Inventory
from . import inventory_bp
from .schemas import inventory_schema, inventories_schema
from utils.decorators import auth_required

# READ all inventory items
@inventory_bp.route("/", methods=["GET"])
@auth_required("admin", "mechanic")
def get_inventory(user_id, role):
    items = db.session.query(Inventory).all()
    return jsonify(inventories_schema.dump(items)), 200

# CREATE new inventory item
@inventory_bp.route("/", methods=["POST"])
@auth_required("admin")
def add_inventory(user_id, role):
    data = request.json
    item = Inventory(name=data["name"], price=data["price"])
    db.session.add(item)
    db.session.commit()
    return jsonify(inventory_schema.dump(item)), 201

# UPDATE existing inventory item
@inventory_bp.route("/<int:item_id>", methods=["PUT"])
@auth_required("admin")
def update_inventory(user_id, role, item_id):
    item = db.session.get(Inventory, item_id)
    if not item:
        return jsonify({"error": "Item not found"}), 404
    data = request.json
    item.name = data.get("name", item.name)
    item.price = data.get("price", item.price)
    db.session.commit()
    return jsonify(inventory_schema.dump(item)), 200

# DELETE inventory item
@inventory_bp.route("/<int:item_id>", methods=["DELETE"])
@auth_required("admin")
def delete_inventory(user_id, role, item_id):
    item = db.session.get(Inventory, item_id)
    if not item:
        return jsonify({"error": "Item not found"}), 404
    db.session.delete(item)
    db.session.commit()
    return jsonify({"message": f"Inventory item {item_id} deleted"}), 200
